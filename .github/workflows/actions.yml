name: Github CI
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Install Codon
        run: |
          mkdir -p ${HOME}/.codon
          curl -L https://github.com/exaloop/codon/releases/download/v0.19.3/codon-linux-x86_64.tar.gz | tar zxvf - --strip-components=1 -C ${HOME}/.codon
          curl -L https://github.com/exaloop/seq/releases/download/v0.11.5/seq-linux-x86_64.tar.gz | tar zxvf - -C ${HOME}/.codon/lib/codon/plugins
          export PATH=${PATH}:${HOME}/.codon/bin
          echo "${HOME}/.codon/bin" >> "$GITHUB_PATH"
      - name: Check out repository code
        uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Set up Codon Python bridge
        run: |
          python -m pip install --upgrade pip
          python -m pip install find_libpython
          echo "CODON_PYTHON=$(python -c 'import find_libpython as f; print(f.find_libpython())')" >> "$GITHUB_ENV"
          echo "Found Python at: ${CODON_PYTHON}"
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      # - name: Week 1
      #   env:
      #     CODON_PYTHON: ${{ env.CODON_PYTHON }}
      #   run: |
      #     chmod +x week1/evaluate.sh
      #     bash week1/evaluate.sh
      # - name: Week 2
      #   working-directory: week2
      #   shell: bash
      #   run: |
      #    # Python deps required by week2/code/utils.py at import time
      #    python -m pip install -U pip pytest numpy biopython
      #    chmod +x evaluate.sh
      #    ./evaluate.sh
      # - name: Week 3
      #   working-directory: week3
      #   shell: bash
      #   env:
      #     CODON_PYTHON: ${{ env.CODON_PYTHON }}
      #   run: |
      #     # Python deps for the baseline + test harness
      #     python -m pip install -U pip setuptools wheel
      #     python -m pip install numpy pytest cython
      #     # Try PyPI first; if biotite wheel isn't available for this Python, fall back to GitHub
      #     python -m pip install biotite || python -m pip install 'git+https://github.com/biotite-dev/biotite@master'
      #     # Run the combined timing script
      #     chmod +x evaluate.sh
      #     ./evaluate.sh
      # - name: Week 4
      #   working-directory: week4
      #   shell: bash
      #   env:
      #     CODON_PYTHON: ${{ env.CODON_PYTHON }}
      #   run: |
      #     chmod +x evaluate.sh
      #     ./evaluate.sh
      # - name: Week 5
      #   shell: bash
      #   working-directory: week5
      #   env:
      #     THREADS: "2"
      #   run: |
      #     set -euxo pipefail
      
      #     sudo apt-get update
      #     sudo apt-get install -y \
      #       minimap2 samtools bcftools tabix \
      #       xvfb openjdk-17-jre curl unzip bzip2
      
      #     python -m pip install --upgrade pip
      #     python -m pip install jupyter nbconvert whatshap
      
      #     jupyter nbconvert \
      #       --to notebook \
      #       --execute \
      #       --ExecutePreprocessor.timeout=3600 \
      #       --output executed.ipynb \
      #       week5.ipynb
      - name: Week 6
        shell: bash
        env:
          MPLBACKEND: Agg
          THREADS: "2"
        run: |
          set -euxo pipefail

          export MAMBA_ROOT_PREFIX="$HOME/micromamba"
          mkdir -p "$MAMBA_ROOT_PREFIX"

          curl -L https://micro.mamba.pm/api/micromamba/linux-64/latest \
            | tar -xvj -C /usr/local/bin --strip-components=1 bin/micromamba

          eval "$(/usr/local/bin/micromamba shell hook -s bash)"

          micromamba create -y -n scweek6 -c conda-forge -c bioconda python=3.11 pip
          micromamba install -y -n scweek6 -c conda-forge -c bioconda \
            scanpy anndata matplotlib pandas numpy h5py umap-learn \
            python-igraph leidenalg jupyter nbconvert celltypist \
            ipywidgets \
            simpleaf alevin-fry salmon || true

          micromamba run -n scweek6 python -m pip install --upgrade pip

          micromamba run -n scweek6 python - <<'PY'
          from celltypist import models
          try:
              models.download_models(model='Immune_All_Low')
          except TypeError:
              models.download_models()
          PY

          micromamba run -n scweek6 jupyter nbconvert \
            --to notebook \
            --execute \
            --inplace \
            --ExecutePreprocessor.timeout=5400 \
            week6.ipynb
